<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Bitget X Moto Gp</title>
    
    <!-- HARƒ∞Cƒ∞ K√úT√úPHANELER -->
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    
    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>

    <style>
        body {
            margin: 0;
            overflow: hidden;
            background-color: #000;
            font-family: 'Courier New', Courier, monospace;
            user-select: none;
            -webkit-touch-callout: none;
            touch-action: none; 
        }

        #ui-container {
            position: absolute;
            top: 20px;
            left: 20px;
            width: 90%;
            display: flex;
            justify-content: space-between;
            pointer-events: none;
            z-index: 10;
        }

        #score-board {
            color: #00ffff;
            text-shadow: 0 0 10px #00ffff;
            font-size: 24px;
            font-weight: bold;
        }

        #shield-status {
            color: #0088ff;
            text-shadow: 0 0 10px #0088ff;
            font-size: 20px;
            font-weight: bold;
            display: none; 
        }
        
        .modal {
            display: none;
            position: fixed; 
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
            background: rgba(0, 15, 30, 0.95);
            border: 2px solid #00ffff;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 0 30px rgba(0, 255, 255, 0.3);
            z-index: 20;
            width: 85%;
            max-width: 400px;
            max-height: 90vh;
            overflow-y: auto;
        }

        #start-screen {
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }

        h1.game-title {
            color: #00ffff;
            text-shadow: 0 0 15px #00ffff;
            font-size: 28px;
            margin-bottom: 15px;
        }

        .legend {
            font-size: 13px; 
            color: #ddd; 
            margin: 5px 0;
            text-align: left;
            width: 100%;
        }

        input[type="text"] {
            background: rgba(0, 0, 0, 0.5);
            border: 1px solid #00ffff;
            color: #00ffff;
            padding: 10px;
            font-size: 16px;
            width: 80%;
            margin-bottom: 15px;
            text-align: center;
            border-radius: 5px;
        }
        
        button {
            background: #00ffff;
            color: #000;
            border: none;
            padding: 12px 24px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            margin: 8px;
            border-radius: 5px;
            width: 80%; 
        }

        button.big-btn {
            font-size: 20px;
            padding: 15px 30px;
            background: linear-gradient(45deg, #00ffff, #0088ff);
            box-shadow: 0 0 20px #00ffff;
        }

        button.secondary {
            background: transparent;
            border: 1px solid #00ffff;
            color: #00ffff;
        }

        #leaderboard-list {
            list-style: none;
            padding: 0;
            margin: 10px 0;
            text-align: left;
            max-height: 150px;
            overflow-y: auto;
        }
        #leaderboard-list li {
            padding: 5px;
            border-bottom: 1px solid rgba(0, 255, 255, 0.2);
            color: #fff;
            font-size: 13px;
        }

        #loading, #commentary-loading { 
            display: none; 
            color: #00ffff; 
            margin-top: 10px; 
            font-size: 12px; 
        }
        
        #commentary-output {
            margin-top: 10px; 
            padding: 10px; 
            border: 1px dashed #ff0aa0; 
            color: #fff; 
            font-style: italic; 
            display: none; 
            text-align: left; 
            font-size: 13px;
        }
    </style>
</head>
<body>
    <div id="ui-container">
        <div id="score-board">BGB: 0</div>
        <div id="shield-status">üõ°Ô∏è KALKAN</div>
    </div>

    <div id="start-screen" class="modal" style="display: flex;">
        <h1 class="game-title">Bitget X Moto GP</h1>
        <div class="legend" style="color: #00ff00;">üü¢ PUMP: +%10 Skor</div>
        <div class="legend" style="color: #ff0000;">üî¥ DUMP: -%10 Skor</div>
        <div class="legend" style="color: #0088ff;">üõ°Ô∏è KALKAN: Koruma</div>
        <br>
        <button class="big-btn" id="btn-start">BA≈ûLA</button>
    </div>

    <div id="game-over-modal" class="modal">
        <h1 style="color: #ff0055; margin: 0;">REKT!</h1>
        <p>Skor: <span id="final-score">0</span> BGB</p>
        
        <div id="save-score-section">
            <input type="text" id="player-name" placeholder="Adƒ±nƒ±z" maxlength="15">
            <button id="btn-save">SKORU KAYDET</button>
        </div>
        
        <button id="btn-gemini" style="background: #ff0aa0; color: white;">
            ‚ú® Piyasa Yorumu
        </button>
        <div id="commentary-loading">Analiz yapƒ±lƒ±yor...</div>
        <div id="commentary-output"></div>

        <button id="btn-share" style="background: #0088cc; color: white; display: none;">
            ‚úàÔ∏è Kanalda Payla≈ü
        </button>
        
        <div style="margin-top: 15px; border-top: 1px solid #333; padding-top: 10px;">
            <button class="secondary" id="btn-reset">TEKRAR OYNA</button>
        </div>
        <div id="loading">Baƒülanƒ±yor...</div>
    </div>

    <div id="leaderboard-modal" class="modal">
        <h2 style="color: #ffd700;">üèÜ Lƒ∞DERLER üèÜ</h2>
        <ul id="leaderboard-list"></ul>
        <button class="secondary" id="btn-close-leaderboard">KAPAT</button>
    </div>

    <script>
    (function() {
        // G√úVENLƒ∞K
        document.addEventListener('contextmenu', event => event.preventDefault());
        document.addEventListener('keydown', function(e) {
            if (e.key === 'F12' || (e.ctrlKey && e.shiftKey && e.key === 'I')) {
                e.preventDefault(); return false;
            }
        });

        // 1. AYARLAR
        const GEMINI_API_KEY = ""; 
        const firebaseConfig = {
            apiKey: "BURAYA_YAPISTIR",
            authDomain: "BURAYA_YAPISTIR",
            projectId: "BURAYA_YAPISTIR",
            storageBucket: "BURAYA_YAPISTIR",
            messagingSenderId: "BURAYA_YAPISTIR",
            appId: "BURAYA_YAPISTIR"
        };
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'neon-motor-game';

        const COLORS = { CYAN: 0x00ffff, RED: 0xff0055, GREEN: 0x00ff00, BLUE: 0x0088ff };
        let scene, camera, renderer, clock;
        let bike, shieldMesh, gridHelper;
        let objects = []; 
        let particles = []; 
        let gameState = { score: 0, speed: 0.4, running: false, crashed: false, shieldTime: 0 };
        let input = { targetX: 0, isActive: false };
        let lastCommentary = "";
        let db, auth;
        const textureLoader = new THREE.TextureLoader();

        window.onload = function() {
            bindEvents();
            initTelegram();
            initFirebase();
            initThreeJS();
            animate();
        };

        function bindEvents() {
            safeAddClick('btn-start', startGame);
            safeAddClick('btn-save', saveScoreAndShowLeaderboard);
            safeAddClick('btn-gemini', generateMarketCommentary);
            safeAddClick('btn-share', shareToTelegram);
            safeAddClick('btn-reset', resetGame);
            safeAddClick('btn-close-leaderboard', closeLeaderboard);
            const nameInput = document.getElementById('player-name');
            if(nameInput) {
                nameInput.addEventListener('focus', () => { input.isActive = true; });
                nameInput.addEventListener('blur', () => { input.isActive = false; });
            }
        }
        function safeAddClick(id, func) {
            const el = document.getElementById(id);
            if(el) el.addEventListener('click', func);
        }

        /* =================================================================
           G√ñRSEL Y√ñNETƒ∞Cƒ∞Sƒ∞ (ASSET MANAGER)
           ================================================================= */
        const AssetManager = {
            getBike: function() {
                // ---> 0. MOTOR G√ñRSELƒ∞ (TEK PAR√áA)
                // 'assets/bike.png' dosyasƒ±nƒ± kullanmak i√ßin alttaki satƒ±rƒ± a√ß:
                // return textureLoader.load('assets/bike.png');
                
                // Varsayƒ±lan: Kod ile √ßizilen basit bir motor arkasƒ± g√∂r√ºnt√ºs√º
                return this.createProceduralTexture('bike');
            },
            getLogo: function() {
                // ---> 1. Logo: 'assets/logo.png' kullanmak i√ßin a√ß:
                // return textureLoader.load('assets/logo.png');
                return this.createProceduralTexture('logo');
            },
            getCoin: function() {
                // ---> 2. Coin: 'assets/coin.png' kullanmak i√ßin a√ß:
                // return textureLoader.load('assets/coin.png');
                return this.createProceduralTexture('coin');
            },
            getPump: function() {
                // return textureLoader.load('assets/pump.png');
                return this.createProceduralTexture('pump');
            },
            getDump: function() {
                // return textureLoader.load('assets/dump.png');
                return this.createProceduralTexture('dump');
            },
            createProceduralTexture: function(type) {
                const canvas = document.createElement('canvas');
                canvas.width = 128; canvas.height = 128;
                const ctx = canvas.getContext('2d');
                const cx = 64, cy = 64;
                if (type === 'bike') {
                    // Basit bir motor arkasƒ± √ßizimi (Placeholder)
                    canvas.width = 128; canvas.height = 128;
                    ctx.fillStyle = '#111'; ctx.fillRect(40, 60, 48, 60); // Teker
                    ctx.fillStyle = '#00ffff'; ctx.fillRect(30, 20, 68, 40); // G√∂vde
                    ctx.fillStyle = '#ff0055'; ctx.beginPath(); ctx.arc(64, 40, 10, 0, Math.PI*2); ctx.fill(); // Stop lambasƒ±
                } else if (type === 'logo') {
                    canvas.width = 256; canvas.height = 64;
                    ctx.fillStyle = '#004444'; ctx.fillRect(0,0,256,64);
                    ctx.strokeStyle = '#00ffff'; ctx.lineWidth = 4; ctx.strokeRect(0,0,256,64);
                    ctx.fillStyle = '#fff'; ctx.font = 'bold 30px Arial'; 
                    ctx.textAlign = 'center'; ctx.fillText('Bitget GP', 128, 42);
                } else if (type === 'coin') {
                    ctx.fillStyle = '#00ffff'; ctx.beginPath(); ctx.arc(cx, cy, 60, 0, Math.PI*2); ctx.fill();
                    ctx.strokeStyle = '#008888'; ctx.lineWidth = 5; ctx.stroke();
                    ctx.fillStyle = '#000'; ctx.font = 'bold 30px Arial'; 
                    ctx.textAlign = 'center'; ctx.fillText('BGB', cx, cy+10);
                } else if (type === 'pump') {
                    ctx.fillStyle = '#00ff00'; ctx.font = 'bold 30px Arial';
                    ctx.textAlign = 'center'; ctx.fillText('PUMP', cx, cy);
                } else if (type === 'dump') {
                    ctx.fillStyle = '#ff0055'; ctx.font = 'bold 30px Arial';
                    ctx.textAlign = 'center'; ctx.fillText('DUMP', cx, cy);
                }
                return new THREE.CanvasTexture(canvas);
            }
        };

        function initThreeJS() {
            clock = new THREE.Clock();
            scene = new THREE.Scene();
            scene.background = new THREE.Color(0x050510);
            scene.fog = new THREE.FogExp2(0x050510, 0.02);
            camera = new THREE.PerspectiveCamera(60, window.innerWidth / window.innerHeight, 0.1, 1000);
            camera.position.set(0, 3, 6); 
            camera.lookAt(0, 0, -4);
            renderer = new THREE.WebGLRenderer({ antialias: true });
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.shadowMap.enabled = true;
            document.body.appendChild(renderer.domElement);
            scene.add(new THREE.AmbientLight(0xffffff, 0.5));
            const dirLight = new THREE.DirectionalLight(0xffffff, 0.8);
            dirLight.position.set(10, 20, 10);
            scene.add(dirLight);
            const pointLight = new THREE.PointLight(COLORS.CYAN, 2, 15);
            pointLight.position.set(0, 1, -1);
            scene.add(pointLight);
            const plane = new THREE.Mesh(new THREE.PlaneGeometry(200, 200), new THREE.MeshPhongMaterial({ color: 0x080808, shininess: 10 }));
            plane.rotation.x = -Math.PI / 2; plane.position.y = -0.1; scene.add(plane);
            gridHelper = new THREE.GridHelper(200, 80, COLORS.CYAN, 0x111111);
            scene.add(gridHelper);
            createBike();
            document.addEventListener('mousemove', handleInput);
            document.addEventListener('touchmove', handleInput, { passive: false });
            document.addEventListener('touchstart', handleInput, { passive: false });
            window.addEventListener('resize', onWindowResize);
        }

        // --- YENƒ∞ BASƒ∞TLE≈ûTƒ∞Rƒ∞LMƒ∞≈û MOTOR OLU≈ûTURMA ---
        function createBike() {
            if(bike) scene.remove(bike);
            bike = new THREE.Group();

            // 1. Motor G√∂rselini Al (AssetManager'dan)
            const bikeTexture = AssetManager.getBike();

            // 2. Tek bir d√ºzlem (Plane) √ºzerine resmi yapƒ±≈ütƒ±r
            // Eƒüer resminiz kare deƒüilse buradaki 1.5, 1.5 oranƒ±nƒ± deƒüi≈ütirebilirsiniz (√∂rn: 1.0, 2.0)
            const geometry = new THREE.PlaneGeometry(1.5, 1.5);
            const material = new THREE.MeshBasicMaterial({ 
                map: bikeTexture, 
                transparent: true, 
                side: THREE.DoubleSide
            });
            
            const bikeMesh = new THREE.Mesh(geometry, material);
            // Resmi dik deƒüil, hafif eƒüik veya tam arkadan g√∂r√ºnecek ≈üekilde ayarlayabiliriz
            // ≈ûu an kameraya bakacak ≈üekilde ayarlƒ±yoruz (Sprite mantƒ±ƒüƒ± ama 3D obje olarak)
            bikeMesh.position.y = 0.75; 
            // bikeMesh.rotation.y = Math.PI; // Eƒüer resim ters ise bunu a√ßƒ±n
            
            bike.add(bikeMesh);

            // Kalkan efekti (Motorun etrafƒ±nda)
            shieldMesh = new THREE.Mesh(new THREE.SphereGeometry(1.0, 32, 32), new THREE.MeshBasicMaterial({ color: COLORS.BLUE, transparent: true, opacity: 0.3, wireframe: true }));
            shieldMesh.visible = false; shieldMesh.position.y = 0.75; bike.add(shieldMesh);
            
            scene.add(bike);
        }

        function spawnObject() {
            if (!gameState.running || gameState.crashed) return;
            const lanes = [-2.5, 0, 2.5];
            const lane = lanes[Math.floor(Math.random() * lanes.length)];
            let mesh, type;
            const rand = Math.random();
            if (rand < 0.4) {
                type = 'coin';
                const geo = new THREE.CylinderGeometry(0.4, 0.4, 0.1, 32); geo.rotateX(Math.PI/2);
                const tex = AssetManager.getCoin();
                const matFace = new THREE.MeshBasicMaterial({ map: tex });
                const matSide = new THREE.MeshBasicMaterial({ color: 0xaa8800 });
                mesh = new THREE.Mesh(geo, [matSide, matFace, matFace]); mesh.rotation.y = Math.PI / 2;
            } else if (rand < 0.5) {
                type = 'pump'; mesh = new THREE.Sprite(new THREE.SpriteMaterial({ map: AssetManager.getPump() })); mesh.scale.set(2, 2, 1);
            } else if (rand < 0.6) {
                type = 'dump'; mesh = new THREE.Sprite(new THREE.SpriteMaterial({ map: AssetManager.getDump() })); mesh.scale.set(2, 2, 1);
            } else if (rand < 0.65) {
                type = 'shield';
                const canvas = document.createElement('canvas'); canvas.width=64; canvas.height=64;
                const ctx = canvas.getContext('2d'); ctx.font='50px Arial'; ctx.fillText('üõ°Ô∏è', 5, 50);
                mesh = new THREE.Sprite(new THREE.SpriteMaterial({ map: new THREE.CanvasTexture(canvas) })); mesh.scale.set(1.5, 1.5, 1);
            } else {
                type = 'obstacle'; mesh = new THREE.Mesh(new THREE.BoxGeometry(1, 1, 1), new THREE.MeshPhongMaterial({ color: COLORS.RED, emissive: 0x330000 }));
            }
            mesh.position.set(lane, 0.6, -60); mesh.userData = { type: type }; scene.add(mesh); objects.push(mesh);
        }

        function animate() {
            requestAnimationFrame(animate);
            if (!gameState.running) { gridHelper.position.z = (gridHelper.position.z + 0.1) % 10; renderer.render(scene, camera); return; }
            if (gameState.crashed) { updateParticles(); renderer.render(scene, camera); return; }
            const delta = clock.getDelta();
            gameState.speed += 0.0001;
            gridHelper.position.z = (gridHelper.position.z + gameState.speed) % 10;
            if (gameState.shieldTime > 0) {
                gameState.shieldTime -= delta; shieldMesh.rotation.y += delta * 2;
                if (gameState.shieldTime <= 0) deactivateShield();
            }
            bike.position.x += (input.targetX - bike.position.x) * 0.1;
            bike.rotation.z = (bike.position.x - input.targetX) * 0.3;
            bike.rotation.y = (input.targetX - bike.position.x) * 0.1;
            if (Math.random() < 0.03 + (gameState.score * 0.0001)) spawnObject();
            for (let i = objects.length - 1; i >= 0; i--) {
                let obj = objects[i]; obj.position.z += gameState.speed;
                if (obj.userData.type === 'coin') obj.rotation.y += 0.05;
                if (['pump', 'dump'].includes(obj.userData.type)) obj.position.y = 0.6 + Math.sin(Date.now()*0.005)*0.2;
                if (obj.position.distanceTo(bike.position) < 1.2) handleCollision(obj, i);
                else if (obj.position.z > 10) { scene.remove(obj); objects.splice(i, 1); }
            }
            updateParticles(); renderer.render(scene, camera);
        }

        function handleCollision(obj, index) {
            const type = obj.userData.type; const pos = obj.position.clone();
            if (type === 'coin') { gameState.score += 10; createParticles(pos, COLORS.CYAN); }
            else if (type === 'pump') { gameState.score = Math.floor(gameState.score * 1.1); createParticles(pos, COLORS.GREEN); }
            else if (type === 'dump') { gameState.score = Math.floor(gameState.score * 0.9); createParticles(pos, COLORS.RED); }
            else if (type === 'shield') { activateShield(); createParticles(pos, COLORS.BLUE); }
            else if (type === 'obstacle') {
                if (gameState.shieldTime > 0) createParticles(pos, COLORS.RED);
                else gameOver();
            }
            if (!gameState.crashed || type !== 'obstacle') { scene.remove(obj); objects.splice(index, 1); updateScoreUI(); }
        }

        function handleInput(e) {
            if (!gameState.running || input.isActive || gameState.crashed) return;
            e.preventDefault();
            let cx = e.touches ? e.touches[0].clientX : e.clientX;
            // D√úZELTME: Mobilde motorun ekran dƒ±≈üƒ±na √ßƒ±kmasƒ±nƒ± engellemek i√ßin sƒ±nƒ±rlandƒ±rma (Clamp)
            let normalized = (cx / window.innerWidth) * 2 - 1;
            // Sƒ±nƒ±rlarƒ± -2.5 ile 2.5 arasƒ±na sabitliyoruz
            input.targetX = Math.max(-2.5, Math.min(2.5, normalized * 3.5));
        }

        function startGame() {
            document.getElementById('start-screen').style.display = 'none';
            gameState.running = true; gameState.crashed = false; gameState.score = 0; gameState.speed = 0.4; clock.start();
        }
        function resetGame() {
            objects.forEach(o => scene.remove(o)); particles.forEach(p => scene.remove(p)); objects = []; particles = [];
            bike.position.set(0,0,0); bike.rotation.set(0,0,0); bike.visible = true; deactivateShield();
            gameState.running = true; gameState.crashed = false; gameState.score = 0; gameState.speed = 0.4; updateScoreUI();
            document.getElementById('game-over-modal').style.display = 'none';
            document.getElementById('leaderboard-modal').style.display = 'none';
            document.getElementById('commentary-output').style.display = 'none';
        }
        function gameOver() {
            gameState.crashed = true; document.getElementById('final-score').innerText = gameState.score;
            document.getElementById('game-over-modal').style.display = 'block';
            bike.visible = false; createParticles(bike.position, COLORS.CYAN, 30);
        }
        function activateShield() { gameState.shieldTime = 5; shieldMesh.visible = true; document.getElementById('shield-status').style.display = 'block'; }
        function deactivateShield() { gameState.shieldTime = 0; shieldMesh.visible = false; document.getElementById('shield-status').style.display = 'none'; }
        function createParticles(pos, color, count=10) {
            for(let i=0; i<count; i++) {
                const m = new THREE.Mesh(new THREE.BoxGeometry(0.1,0.1,0.1), new THREE.MeshBasicMaterial({color:color}));
                m.position.copy(pos); m.userData = { vel: new THREE.Vector3((Math.random()-0.5), (Math.random()-0.5), (Math.random()-0.5)), life: 1.0 };
                particles.push(m); scene.add(m);
            }
        }
        function updateParticles() {
            for(let i=particles.length-1; i>=0; i--) {
                let p = particles[i]; p.position.add(p.userData.vel); p.userData.life -= 0.05; p.scale.multiplyScalar(0.9);
                if(p.userData.life <= 0) { scene.remove(p); particles.splice(i,1); }
            }
        }
        function updateScoreUI() { document.getElementById('score-board').innerText = 'BGB: ' + gameState.score; }
        function onWindowResize() { camera.aspect = window.innerWidth/window.innerHeight; camera.updateProjectionMatrix(); renderer.setSize(window.innerWidth, window.innerHeight); }

        function initTelegram() {
            if (window.Telegram?.WebApp) {
                const tg = window.Telegram.WebApp; tg.ready(); tg.expand();
                if(tg.initDataUnsafe?.user?.first_name) {
                    const inp = document.getElementById('player-name'); if(inp) inp.value = tg.initDataUnsafe.user.first_name;
                }
            }
        }
        
        async function initFirebase() {
            if (firebaseConfig.apiKey === "BURAYA_YAPISTIR") {
                console.warn("Firebase ayarlarƒ± yapƒ±lmamƒ±≈ü!");
                return;
            }
            try {
                firebase.initializeApp(firebaseConfig);
                db = firebase.firestore();
                auth = firebase.auth();
                await auth.signInAnonymously();
            } catch(e) { console.error("Firebase hatasƒ±:", e); }
        }

        async function generateMarketCommentary() {
            const out = document.getElementById('commentary-output');
            const load = document.getElementById('commentary-loading');
            out.style.display = 'none'; load.style.display = 'block';
            if(!GEMINI_API_KEY) {
                out.innerText = "Yapay zeka anahtarƒ± eksik."; out.style.display='block'; load.style.display='none'; return;
            }
            try {
                const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${GEMINI_API_KEY}`;
                const resp = await fetch(url, {
                    method: 'POST', headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ contents: [{ parts: [{ text: `Skor: ${gameState.score} BGB. Piyasa yorumu yap.` }] }] })
                });
                const data = await resp.json();
                out.innerHTML = data.candidates?.[0]?.content?.parts?.[0]?.text || "Piyasa sessiz...";
                out.style.display = 'block';
            } catch(e) { out.innerText = "Hata olu≈ütu."; out.style.display = 'block'; }
            finally { load.style.display = 'none'; }
        }

        function shareToTelegram() {
            const text = `üèçÔ∏è Bitget GP Skor: ${gameState.score} BGB!`;
            const url = `https://t.me/share/url?url=${encodeURIComponent(window.location.href)}&text=${encodeURIComponent(text)}`;
            window.open(url, '_blank');
        }

        async function saveScoreAndShowLeaderboard() {
            if(!db) { alert("Veritabanƒ± baƒülantƒ±sƒ± yok. L√ºtfen index.html i√ßindeki Firebase ayarlarƒ±nƒ± yapƒ±n."); return; }
            const name = document.getElementById('player-name').value || "Anonim";
            try {
                await db.collection('leaderboard').add({
                    name: name, score: gameState.score, timestamp: firebase.firestore.FieldValue.serverTimestamp()
                });
                document.getElementById('game-over-modal').style.display = 'none';
                showLeaderboardOnly();
            } catch(e) { alert("Kaydetme hatasƒ±: " + e.message); }
        }

        async function showLeaderboardOnly() {
            document.getElementById('leaderboard-modal').style.display = 'block';
            const list = document.getElementById('leaderboard-list');
            list.innerHTML = '<li>Y√ºkleniyor...</li>';
            if(!db) { list.innerHTML='<li>Veritabanƒ± yok.</li>'; return; }
            
            const snap = await db.collection('leaderboard').orderBy('score', 'desc').limit(10).get();
            list.innerHTML = '';
            snap.forEach((doc, i) => {
                const d = doc.data();
                const li = document.createElement('li');
                li.innerText = `${i+1}. ${d.name} - ${d.score} BGB`;
                list.appendChild(li);
            });
        }
        function closeLeaderboard() { document.getElementById('leaderboard-modal').style.display = 'none'; }
    })();
    </script>
</body>
</html>