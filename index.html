<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Bitget BlockGP - Customizable Edition</title>
    
    <!-- HARƒ∞Cƒ∞ K√úT√úPHANELER -->
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    
    <!-- HATA D√úZELTME 1: GLTFLoader hatasƒ±nƒ± √∂nlemek i√ßin g√ºvenilir CDN'e ge√ßildi -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/examples/js/loaders/GLTFLoader.js"></script>
    
    <!-- Firebase SDKs (Bunlar global y√ºklenmeye devam edebilir) -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Rajdhani:wght@500;700;900&display=swap');

        body {
            margin: 0;
            overflow: hidden;
            background-color: #0f0518; 
            font-family: 'Rajdhani', sans-serif;
            user-select: none;
            -webkit-touch-callout: none;
            touch-action: none; 
        }

        /* Y√úKLEME EKRANI (Modeller y√ºklenirken g√∂r√ºn√ºr) */
        #loader-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: #000; z-index: 9999; display: flex;
            justify-content: center; align-items: center; color: #00c4cc;
            font-size: 24px; font-weight: bold; transition: opacity 0.5s;
        }

        #ui-container {
            position: absolute; top: 20px; left: 20px; width: calc(100% - 40px);
            display: flex; justify-content: space-between; pointer-events: none; z-index: 10;
        }

        #score-board {
            color: #fff; font-size: 22px; font-weight: 700;
            background: rgba(0, 196, 204, 0.15); backdrop-filter: blur(8px);
            padding: 10px 20px; border-radius: 16px;
            border: 1px solid rgba(0, 196, 204, 0.3);
            box-shadow: 0 4px 15px rgba(0, 196, 204, 0.2);
            display: flex; align-items: center; gap: 10px;
        }

        #status-container {
            display: flex; flex-direction: column; align-items: flex-end; gap: 8px;
        }

        .status-item {
            font-size: 14px; font-weight: 800; display: none;
            padding: 8px 16px; border-radius: 12px;
            background: rgba(0, 0, 0, 0.85); backdrop-filter: blur(4px);
            text-transform: uppercase; letter-spacing: 1px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.5);
            animation: slideIn 0.3s ease-out;
        }
        @keyframes slideIn { from { transform: translateX(20px); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
        
        #nitro-status { color: #00ffff; border-left: 4px solid #00ffff; }
        #shield-status { color: #0088ff; border-left: 4px solid #0088ff; }
        
        .float-text {
            position: absolute; font-weight: 900; font-size: 32px;
            pointer-events: none; animation: floatUp 1.0s forwards;
            text-shadow: 0 4px 10px rgba(0,0,0,0.8); z-index: 15;
            -webkit-text-stroke: 1px rgba(255,255,255,0.2);
        }

        @keyframes floatUp {
            0% { transform: translateY(0) scale(0.5); opacity: 0; }
            20% { transform: translateY(-30px) scale(1.2); opacity: 1; }
            100% { transform: translateY(-120px) scale(1); opacity: 0; }
        }
        
        .modal {
            display: none; position: fixed; top: 50%; left: 50%;
            transform: translate(-50%, -50%); text-align: center;
            background: rgba(16, 18, 27, 0.9); backdrop-filter: blur(20px);
            border: 1px solid rgba(255,255,255,0.1); padding: 35px 30px;
            border-radius: 30px; box-shadow: 0 30px 60px -10px rgba(0, 0, 0, 0.9);
            z-index: 20; width: 85%; max-width: 380px; color: #fff;
        }

        h1.game-title {
            background: linear-gradient(135deg, #00ffff 0%, #0088ff 100%);
            -webkit-background-clip: text; -webkit-text-fill-color: transparent;
            text-transform: uppercase; font-size: 36px; margin: 0 0 5px 0;
            font-weight: 900; letter-spacing: 1px;
        }

        p.game-subtitle {
            margin: 0 0 25px 0; color: #8899aa; font-size: 14px;
            font-weight: 600; letter-spacing: 3px; text-transform: uppercase;
        }

        .legend-container {
            display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 25px;
        }

        .legend {
            font-size: 13px; color: #ddeeff; background: rgba(255,255,255,0.03);
            padding: 12px 10px; border-radius: 16px; display: flex;
            flex-direction: column; align-items: center; justify-content: center;
            border: 1px solid rgba(255,255,255,0.05); transition: transform 0.2s;
        }
        .legend b { font-size: 15px; margin-bottom: 2px; }
        .legend span { font-size: 11px; opacity: 0.7; }

        input[type="text"] {
            background: rgba(0,0,0,0.4); border: 1px solid rgba(255,255,255,0.15);
            color: #fff; padding: 16px; font-size: 18px; width: 100%;
            box-sizing: border-box; margin-bottom: 20px; text-align: center;
            border-radius: 16px; font-weight: 700; font-family: 'Rajdhani', sans-serif;
            outline: none; transition: 0.3s;
        }
        input[type="text"]:focus { border-color: #00c4cc; background: rgba(0, 196, 204, 0.15); }
        
        button {
            background: #00c4cc; color: #000; border: none; padding: 16px 20px;
            font-size: 18px; font-weight: 800; cursor: pointer; margin: 10px 0;
            border-radius: 16px; width: 100%; text-transform: uppercase;
            font-family: 'Rajdhani', sans-serif; letter-spacing: 1px;
            transition: all 0.2s ease; position: relative; overflow: hidden;
            white-space: nowrap; text-overflow: ellipsis;
        }
        button:active { transform: scale(0.97); }

        button.big-btn {
            background: linear-gradient(90deg, #00c4cc, #0088ff); color: #fff;
            box-shadow: 0 8px 20px rgba(0, 196, 204, 0.3);
        }
        button.big-btn:hover { box-shadow: 0 10px 25px rgba(0, 196, 204, 0.5); transform: translateY(-2px); }

        button.secondary {
            background: transparent; border: 1px solid rgba(255,255,255,0.2);
            color: #8899aa; font-size: 14px; padding: 12px;
        }
        button.secondary:hover { border-color: #fff; color: #fff; background: rgba(255,255,255,0.05); }

        #leaderboard-list {
            list-style: none; padding: 0; margin: 15px 0; text-align: left;
            max-height: 180px; overflow-y: auto;
        }
        #leaderboard-list li {
            padding: 10px 14px; background: rgba(255,255,255,0.04);
            margin-bottom: 6px; border-radius: 10px; font-size: 14px;
            display: flex; justify-content: space-between; align-items: center;
            border-left: 4px solid transparent;
        }
        #leaderboard-list li:nth-child(1) { border-left-color: #ffd700; background: linear-gradient(90deg, rgba(255, 215, 0, 0.15), rgba(255,255,255,0.04)); }
        #leaderboard-list li:nth-child(2) { border-left-color: #c0c0c0; }
        #leaderboard-list li:nth-child(3) { border-left-color: #cd7f32; }

        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: rgba(0,0,0,0.1); }
        ::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.2); border-radius: 3px; }

        #speed-lines {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            pointer-events: none; opacity: 0;
            background: radial-gradient(circle, transparent 40%, rgba(0, 196, 204, 0.15) 90%);
            transition: opacity 0.3s; z-index: 5;
        }
    </style>
</head>
<body>
    <div id="loader-overlay">Y√úKLENƒ∞YOR...</div>
    <div id="speed-lines"></div>

    <div id="ui-container">
        <div id="score-board">
            <span style="font-size: 22px;">ü™ô</span> <span id="score-text">0 BGB</span>
        </div>
        <div id="status-container">
            <div id="nitro-status" class="status-item">üöÄ MAX HIZ</div>
            <div id="shield-status" class="status-item">üõ°Ô∏è KALKAN</div>
        </div>
    </div>

    <div id="floating-text-container" style="position: absolute; top:0; left:0; width:100%; height:100%; pointer-events:none; z-index:20;"></div>

    <div id="start-screen" class="modal" style="display: flex; flex-direction: column;">
        <h1 class="game-title">BITGET BLOCKGP</h1>
        <p class="game-subtitle">Crypto Racing League</p>
        <div class="legend-container">
            <div class="legend" style="border-bottom: 3px solid #00ff88;"><b style="color:#00ff88">PUMP</b><span>+10% Skor</span></div>
            <div class="legend" style="border-bottom: 3px solid #ff4455;"><b style="color:#ff4455">DUMP</b><span>-10% Skor</span></div>
            <div class="legend" style="border-bottom: 3px solid #00c4cc;"><b style="color:#00c4cc">COIN</b><span>Puan Topla</span></div>
            <div class="legend" style="border-bottom: 3px solid #0088ff;"><b style="color:#0088ff">KALKAN</b><span>Koruma</span></div>
        </div>
        <button class="big-btn" id="btn-start">YARI≈ûA BA≈ûLA</button>
    </div>

    <!-- Diƒüer Modallar -->
    <div id="game-over-modal" class="modal">
        <h1 style="color: #ff4455; font-size: 42px; margin-bottom: 10px; text-shadow: 0 0 20px rgba(255, 68, 85, 0.4);">REKT!</h1>
        <p style="color:#8899aa; margin:0 0 5px 0; font-size:14px; letter-spacing: 1px;">PORTF√ñY DURUMU</p>
        <p style="margin:0 0 25px 0;"><span id="final-score" style="color:#fff; font-weight:900; font-size:36px;">0</span> <span style="color:#00c4cc; font-size:22px; font-weight:700;">BGB</span></p>
        <div id="save-score-section">
            <input type="text" id="player-name" placeholder="Trader Adƒ±" maxlength="15">
            <button class="big-btn" id="btn-save">SKORU KAYDET</button>
        </div>
        
        <button id="btn-share" style="background: #24a1de; color: white; display: none; margin-top:10px;">‚úàÔ∏è Telegram Payla≈ü</button>
        <button class="secondary" id="btn-reset" style="margin-top:15px;">TEKRAR DENE</button>
    </div>

    <div id="leaderboard-modal" class="modal">
        <h2 style="color: #fff; margin-bottom: 5px;">üèÜ Lƒ∞DER TABLOSU</h2>
        <ul id="leaderboard-list"></ul>
        <button class="secondary" id="btn-close-leaderboard">KAPAT</button>
    </div>

    <script>
        // --- 1. √ñZELLE≈ûTƒ∞RME ALANI (G√ñRSELLERƒ∞ BURADAN DEƒûƒ∞≈ûTƒ∞Rƒ∞N) ---
        
        const VARLIKLAR = {
            // -- KAPLAMALAR (RESƒ∞M) --
            dokular: {
                yol: "", coin: "", bina: "", zemin: "", logo_btc: "", logo_eth: ""
            },
            // -- 3D MODELLER (GLB/GLTF) --
            modeller: {
                motor: "", araba: ""
            }
        };

        const OYUN_AYARLARI = {
            baslangicHizi: 0.5,
            maksimumHiz: 1.5,
            trafikYogunlugu: 1.0, 
            kalkanSuresi: 5.0
        };

        // --- Sƒ∞STEM DEƒûƒ∞≈ûKENLERƒ∞ ---
        
        const firebaseConfig = {
            apiKey: "AIzaSyBsyA9O5a6T07619VVr12ET4EAcRqAut7w",
            authDomain: "bitgetmotogp.firebaseapp.com",
            projectId: "bitgetmotogp",
            storageBucket: "bitgetmotogp.firebasestorage.app",
            messagingSenderId: "bitgetmotogp.firebasestorage.app",
            appId: "G-EB4DNJ9P21"
        };
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'neon-motor-game';

        const COLORS = {
            BITGET_TEAL: 0x00c4cc, BITGET_BLUE: 0x0088cc, SIDEWALK: 0x444455,
            GRASS: 0x111115, SKY: 0x0f0518, LAMP: 0xffcc00, GREEN: 0x00ff88, RED: 0xff4455
        };

        let scene, camera, renderer, clock;
        let bike, shieldMesh;
        let roadMesh;
        let objects = []; 
        let envObjects = []; 
        let textureLoader, gltfLoader;
        
        let gameState = { 
            score: 0, baseSpeed: 0.5, currentSpeed: 0.5, running: false, 
            crashed: false, nitroTime: 0, shieldTime: 0, distanceTraveled: 0,
            isAuthReady: false // Firebase yetkilendirme durumunu takip etmek i√ßin eklendi.
        };
        let input = { targetX: 0, isActive: false };
        let db, auth;

        // --- AKILLI VARLIK Y√ñNETƒ∞Cƒ∞Sƒ∞ ---
        const AssetManager = {
            loadTexture: function(key, fallbackFunction) {
                const url = VARLIKLAR.dokular[key];
                if (!textureLoader) textureLoader = new THREE.TextureLoader();

                if (url && url.length > 0) {
                    return textureLoader.load(url, 
                        () => {}, 
                        undefined,
                        (err) => { console.warn(`Texture ${key} y√ºklenemedi, varsayƒ±lan kullanƒ±lƒ±yor.`); } 
                    );
                }
                return fallbackFunction(); 
            },
            
            getRoadTexture: function() {
                return this.loadTexture('yol', () => {
                    const canvas = document.createElement('canvas'); canvas.width=512; canvas.height=512; const ctx=canvas.getContext('2d');
                    ctx.fillStyle='#222226'; ctx.fillRect(0,0,512,512); 
                    for(let i=0;i<2000;i++){ctx.fillStyle=Math.random()<0.5?'#26262a':'#1e1e22'; ctx.beginPath(); ctx.arc(Math.random()*512,Math.random()*512,1,0,Math.PI*2); ctx.fill();}
                    ctx.shadowBlur = 10; ctx.shadowColor = '#fff';
                    ctx.fillStyle='#fff'; ctx.fillRect(165,0,8,200); ctx.fillRect(165,256,8,200); ctx.fillRect(335,0,8,200); ctx.fillRect(335,256,8,200);
                    const tex=new THREE.CanvasTexture(canvas); tex.wrapS=THREE.RepeatWrapping; tex.wrapT=THREE.RepeatWrapping; return tex;
                });
            },
            createBuildingTexture: function() {
                return this.loadTexture('bina', () => {
                    const canvas = document.createElement('canvas'); canvas.width=128; canvas.height=256; const ctx=canvas.getContext('2d');
                    const grad = ctx.createLinearGradient(0,0,0,256); grad.addColorStop(0, '#2a2a40'); grad.addColorStop(1, '#1a1a20');
                    ctx.fillStyle=grad; ctx.fillRect(0,0,128,256);
                    const litWindowColor='#00c4cc'; ctx.shadowBlur = 5; ctx.shadowColor = litWindowColor;
                    for(let y=20;y<240;y+=30){
                        for(let x=10;x<110;x+=25){
                            if(Math.random()<0.3){ ctx.fillStyle=litWindowColor; if(ctx.roundRect) { ctx.beginPath(); ctx.roundRect(x,y,15,20, 5); ctx.fill(); } else { ctx.fillRect(x,y,15,20); } }
                            else { ctx.fillStyle='#111'; if(ctx.roundRect) { ctx.beginPath(); ctx.roundRect(x,y,15,20, 5); ctx.fill(); } else { ctx.fillRect(x,y,15,20); } }
                        }
                    }
                    return new THREE.CanvasTexture(canvas);
                });
            },
            getCoinTexture: function() {
                return this.loadTexture('coin', () => {
                    const canvas = document.createElement('canvas'); canvas.width = 128; canvas.height = 128; const ctx = canvas.getContext('2d');
                    ctx.fillStyle = '#00c4cc'; ctx.beginPath(); ctx.arc(64, 64, 60, 0, Math.PI*2); ctx.fill();
                    ctx.fillStyle = '#fff'; ctx.font = 'bold 30px Arial'; ctx.textAlign = 'center'; ctx.textBaseline = 'middle';
                    ctx.fillText('BGB', 64, 64);
                    ctx.strokeStyle = '#fff'; ctx.lineWidth=5; ctx.beginPath(); ctx.arc(64, 64, 55, 0, Math.PI*2); ctx.stroke();
                    return new THREE.CanvasTexture(canvas);
                });
            },
            getCryptoLogo: function(symbol) {
                const key = symbol === 'BTC' ? 'logo_btc' : 'logo_eth';
                return this.loadTexture(key, () => {
                    const canvas = document.createElement('canvas'); canvas.width=128; canvas.height=128; const ctx=canvas.getContext('2d');
                    let color = symbol === 'BTC' ? '#f7931a' : '#627eea';
                    ctx.fillStyle = color; ctx.beginPath(); ctx.arc(64,64,60,0,Math.PI*2); ctx.fill();
                    ctx.fillStyle = '#fff'; ctx.font='bold 50px Arial'; ctx.textAlign='center'; ctx.textBaseline='middle';
                    ctx.fillText(symbol, 64, 64);
                    return new THREE.CanvasTexture(canvas);
                });
            }
        };

        // HATA D√úZELTME 2: Firebase'in tam olarak y√ºklenmesini beklemek i√ßin async/await kullanƒ±lƒ±yor.
        window.onload = async function() {
            bindEvents(); 
            initTelegram(); 
            // Yetkilendirme tamamlanmadan diƒüer i≈ülemler ba≈ülamaz.
            await initFirebase(); 
            initThreeJS();
        };

        function bindEvents() {
            safeAddClick('btn-start', startGame); safeAddClick('btn-save', saveScoreAndShowLeaderboard);
            safeAddClick('btn-share', shareToTelegram);
            safeAddClick('btn-reset', resetGame); safeAddClick('btn-close-leaderboard', closeLeaderboard);
            const nameInput = document.getElementById('player-name');
            if(nameInput) { nameInput.addEventListener('focus', ()=>{input.isActive=true;}); nameInput.addEventListener('blur', ()=>{input.isActive=false;}); }
        }
        function safeAddClick(id, func) { const el = document.getElementById(id); if(el) el.addEventListener('click', func); }

        function initThreeJS() {
            // THREE ve GLTFLoader artƒ±k global olarak eri≈üilebilir olduƒüu i√ßin, new THREE.Clock() gibi √ßaƒürƒ±lar sorunsuz √ßalƒ±≈üƒ±r.
            clock = new THREE.Clock(); scene = new THREE.Scene();
            scene.background = new THREE.Color(COLORS.SKY); scene.fog = new THREE.FogExp2(COLORS.SKY, 0.025);
            camera = new THREE.PerspectiveCamera(60, window.innerWidth / window.innerHeight, 0.1, 1000);
            camera.position.set(0, 3.5, 7); camera.lookAt(0, 0, -5);
            renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.shadowMap.enabled = true; renderer.shadowMap.type = THREE.PCFSoftShadowMap; 
            document.body.appendChild(renderer.domElement);

            textureLoader = new THREE.TextureLoader();
            // GLTFLoader'ƒ± kontrol ediyoruz. Eƒüer y√ºklendi ise kullanƒ±r.
            if (typeof GLTFLoader === 'undefined') {
                console.error("GLTFLoader k√ºt√ºphanesi y√ºklenemedi. 3D model y√ºkleme √ßalƒ±≈ümayabilir.");
                gltfLoader = { load: (url, onSuccess, onProgress, onError) => onError(new Error("GLTFLoader is not available.")) };
            } else {
                gltfLoader = new GLTFLoader();
            }


            const ambient = new THREE.AmbientLight(0xffffff, 0.6); scene.add(ambient);
            const dirLight = new THREE.DirectionalLight(0xffffff, 0.8); dirLight.position.set(20, 50, -20);
            dirLight.castShadow = true; dirLight.shadow.mapSize.width=2048; dirLight.shadow.mapSize.height=2048; scene.add(dirLight);
            const blueLight = new THREE.PointLight(COLORS.BITGET_TEAL, 0.5, 50); blueLight.position.set(-10, 10, -20); scene.add(blueLight);

            // Ba≈ülangƒ±√ß Y√ºklemeleri
            createRoad();
            loadPlayerBike(); // Asenkron olabilir
            
            // Y√ºkleme ekranƒ±nƒ± kapat
            setTimeout(() => {
                document.getElementById('loader-overlay').style.opacity = '0';
                setTimeout(() => document.getElementById('loader-overlay').style.display='none', 500);
            }, 1000);

            document.addEventListener('mousemove', handleInput);
            document.addEventListener('touchmove', handleInput, { passive: false });
            document.addEventListener('touchstart', handleInput, { passive: false });
            window.addEventListener('resize', onWindowResize);
            
            animate();
        }

        function createRoad() {
            const roadGeo = new THREE.PlaneGeometry(12, 200); 
            const roadTex = AssetManager.getRoadTexture(); 
            roadTex.wrapT = THREE.RepeatWrapping; roadTex.repeat.set(1, 10); 
            const roadMat = new THREE.MeshPhongMaterial({ map: roadTex, shininess: 20, color: 0xaaaaaa }); 
            roadMesh = new THREE.Mesh(roadGeo, roadMat); roadMesh.rotation.x = -Math.PI / 2; roadMesh.receiveShadow = true; scene.add(roadMesh);
            
            const sidewalkGeo = new THREE.PlaneGeometry(4, 200); const sidewalkMat = new THREE.MeshPhongMaterial({ color: COLORS.SIDEWALK }); 
            const leftSw = new THREE.Mesh(sidewalkGeo, sidewalkMat); leftSw.rotation.x = -Math.PI / 2; leftSw.position.set(-8, 0.02, 0); leftSw.receiveShadow=true; scene.add(leftSw); 
            const rightSw = new THREE.Mesh(sidewalkGeo, sidewalkMat); rightSw.rotation.x = -Math.PI / 2; rightSw.position.set(8, 0.02, 0); rightSw.receiveShadow=true; scene.add(rightSw); 
            
            const grassGeo = new THREE.PlaneGeometry(100, 200); const grassMat = new THREE.MeshLambertMaterial({ color: COLORS.GRASS }); 
            if(VARLIKLAR.dokular.zemin) grassMat.map = textureLoader.load(VARLIKLAR.dokular.zemin);
            const grass = new THREE.Mesh(grassGeo, grassMat); grass.rotation.x = -Math.PI/2; grass.position.y = -0.1; scene.add(grass);
        }

        // --- MOTOR Y√úKLEME (MODEL Mƒ∞ KOD MU?) ---
        function loadPlayerBike() {
            const modelUrl = VARLIKLAR.modeller.motor;
            
            if (modelUrl && modelUrl.length > 0) {
                // GLTF Modeli Y√ºkle
                // HATA D√úZELTME: gltfLoader artƒ±k global olarak eri≈üilebilir, ancak kontrol edilmeli.
                if (typeof GLTFLoader === 'undefined') {
                    console.error("GLTFLoader tanƒ±mlƒ± deƒüil. Varsayƒ±lan model kullanƒ±lƒ±yor.");
                    createProceduralBike();
                    return;
                }

                gltfLoader.load(modelUrl, (gltf) => {
                    const model = gltf.scene;
                    // Modeli √∂l√ßekle ve y√∂nlendir (Bu kƒ±sƒ±m modelin kendisine g√∂re ayar gerektirebilir)
                    model.scale.set(0.5, 0.5, 0.5); 
                    model.rotation.y = Math.PI; // Genelde modeller ters gelir
                    model.traverse(function(node) { if(node.isMesh) { node.castShadow = true; } });
                    
                    const group = new THREE.Group();
                    group.add(model);
                    // Kalkanƒ± yine de ekle
                    setupShield(group);
                    scene.add(group);
                    bike = group;
                }, undefined, (error) => {
                    console.error("Model y√ºklenemedi, varsayƒ±lan olu≈üturuluyor.", error);
                    createProceduralBike(); // Hata olursa kodla olu≈ütur
                });
            } else {
                createProceduralBike();
            }
        }

        function createProceduralBike() {
            const group = new THREE.Group();
            const bodyMat = new THREE.MeshStandardMaterial({ color: COLORS.BITGET_TEAL, metalness: 0.6, roughness: 0.2 });
            const darkMat = new THREE.MeshStandardMaterial({ color: 0x111111, metalness: 0.2, roughness: 0.8 }); 
            const metalMat = new THREE.MeshStandardMaterial({ color: 0x888888, metalness: 0.9, roughness: 0.2 }); 
            const glassMat = new THREE.MeshStandardMaterial({ color: 0x000000, transparent: true, opacity: 0.6, metalness: 0.9, roughness: 0.0 });

            // ... (Eski motor kodlarƒ± aynen buraya) ...
            const engine = new THREE.Mesh(new THREE.BoxGeometry(0.5, 0.5, 0.9), darkMat); engine.position.y = 0.5; engine.castShadow=true; group.add(engine);
            const tank = new THREE.Mesh(new THREE.BoxGeometry(0.55, 0.35, 0.7), bodyMat); tank.position.set(0, 0.95, 0.0); tank.castShadow=true; group.add(tank);
            const tail = new THREE.Mesh(new THREE.BoxGeometry(0.4, 0.2, 0.5), bodyMat); tail.position.set(0, 1.0, 0.7); tail.castShadow=true; group.add(tail);
            const seat = new THREE.Mesh(new THREE.BoxGeometry(0.42, 0.1, 0.45), darkMat); seat.position.set(0, 1.05, 0.4); group.add(seat);
            const fairingL = new THREE.Mesh(new THREE.BoxGeometry(0.1, 0.6, 0.8), bodyMat); fairingL.position.set(-0.28, 0.65, -0.2); fairingL.rotation.z = 0.2; group.add(fairingL);
            const fairingR = new THREE.Mesh(new THREE.BoxGeometry(0.1, 0.6, 0.8), bodyMat); fairingR.position.set(0.28, 0.65, -0.2); fairingR.rotation.z = -0.2; group.add(fairingR);
            const nose = new THREE.Mesh(new THREE.BoxGeometry(0.5, 0.4, 0.5), bodyMat); nose.position.set(0, 0.9, -0.6); group.add(nose);
            const windshield = new THREE.Mesh(new THREE.BoxGeometry(0.45, 0.3, 0.05), glassMat); windshield.position.set(0, 1.2, -0.7); windshield.rotation.x = -0.5; group.add(windshield);
            
            // Tekerlekler
            const wheelGeo = new THREE.CylinderGeometry(0.38, 0.38, 0.25, 32); wheelGeo.rotateZ(Math.PI/2);
            const wF = new THREE.Mesh(wheelGeo, darkMat); wF.position.set(0, 0.38, -1.1); wF.castShadow=true; group.add(wF);
            const rimF = new THREE.Mesh(new THREE.CylinderGeometry(0.25, 0.25, 0.26, 16), metalMat); rimF.rotateZ(Math.PI/2); rimF.position.copy(wF.position); group.add(rimF);
            const wR = new THREE.Mesh(wheelGeo, darkMat); wR.position.set(0, 0.38, 1.1); wR.castShadow=true; group.add(wR);
            const rimR = new THREE.Mesh(new THREE.CylinderGeometry(0.25, 0.25, 0.26, 16), metalMat); rimR.rotateZ(Math.PI/2); rimR.position.copy(wR.position); group.add(rimR);

            // S√ºr√ºc√º
            const riderBody = new THREE.Mesh(new THREE.BoxGeometry(0.45, 0.5, 0.3), bodyMat); riderBody.position.set(0, 1.35, 0.2); riderBody.rotation.x = 0.5; group.add(riderBody);
            const helmet = new THREE.Mesh(new THREE.SphereGeometry(0.22, 16, 16), darkMat); helmet.position.set(0, 1.65, -0.1); group.add(helmet);

            setupShield(group);
            scene.add(group); bike = group;
        }

        function setupShield(parentGroup) {
            shieldMesh = new THREE.Mesh(new THREE.SphereGeometry(1.8, 32, 32), new THREE.MeshPhongMaterial({ color: 0x0088ff, transparent: true, opacity: 0.3, emissive: 0x004488, wireframe: false }));
            shieldMesh.visible = false; shieldMesh.position.y = 1.0; 
            parentGroup.add(shieldMesh);
        }

        function createCar(lane, zPos) {
            // (Araba i√ßin de model desteƒüi eklenebilir ama kod uzamamasƒ± i√ßin basit bƒ±rakƒ±yorum)
            const group = new THREE.Group();
            const colors = [0xff3333, 0x3333ff, 0xffaa00, 0xffffff];
            const carColor = colors[Math.floor(Math.random()*colors.length)];
            const bodyMat = new THREE.MeshStandardMaterial({ color: carColor, metalness: 0.5, roughness: 0.2 });
            const glassMat = new THREE.MeshStandardMaterial({ color: 0x111111, metalness: 0.9, roughness: 0.1 });
            const baseGeo = new THREE.BoxGeometry(1.6, 0.6, 3.8);
            const base = new THREE.Mesh(baseGeo, bodyMat); base.position.y = 0.6; base.castShadow = true; group.add(base);
            const topGeo = new THREE.SphereGeometry(1, 32, 32);
            const top = new THREE.Mesh(topGeo, glassMat); top.scale.set(0.7, 0.5, 1.2); top.position.set(0, 0.9, -0.2); group.add(top);
            // Tekerlekler
            const wGeo = new THREE.CylinderGeometry(0.3, 0.3, 0.4, 16); wGeo.rotateZ(Math.PI/2); const wMat = new THREE.MeshBasicMaterial({color:0x000000});
            const wFL = new THREE.Mesh(wGeo, wMat); wFL.position.set(-0.7, 0.3, -1.2); group.add(wFL);
            const wFR = new THREE.Mesh(wGeo, wMat); wFR.position.set(0.7, 0.3, -1.2); group.add(wFR);
            const wBL = new THREE.Mesh(wGeo, wMat); wBL.position.set(-0.7, 0.3, 1.2); group.add(wBL);
            const wBR = new THREE.Mesh(wGeo, wMat); wBR.position.set(0.7, 0.3, 1.2); group.add(wBR);
            group.position.set(lane, 0, zPos); group.userData = { type: 'car' }; scene.add(group); objects.push(group);
        }

        // ... (Diƒüer fonksiyonlar: createPump, createDump aynen kalƒ±yor)
        function createPump(x, z) { const group = new THREE.Group(); const mat = new THREE.MeshPhongMaterial({ color: COLORS.GREEN, emissive: 0x004400 }); const cone = new THREE.Mesh(new THREE.ConeGeometry(0.4, 0.6, 16), mat); cone.position.y = 1.0; group.add(cone); const cyl = new THREE.Mesh(new THREE.CylinderGeometry(0.15, 0.15, 0.6, 16), mat); cyl.position.y = 0.4; group.add(cyl); const ring = new THREE.Mesh(new THREE.TorusGeometry(0.4, 0.05, 8, 16), mat); ring.rotation.x = Math.PI/2; ring.position.y = 0.5; group.add(ring); group.position.set(x, 0.5, z); group.userData = { type: 'pump' }; group.userData.rotSpeed = 0.05; scene.add(group); objects.push(group); }
        function createDump(x, z) { const group = new THREE.Group(); const mat = new THREE.MeshPhongMaterial({ color: COLORS.RED, emissive: 0x440000 }); const cone = new THREE.Mesh(new THREE.ConeGeometry(0.4, 0.6, 16), mat); cone.rotation.z = Math.PI; cone.position.y = 0.4; group.add(cone); const cyl = new THREE.Mesh(new THREE.CylinderGeometry(0.15, 0.15, 0.6, 16), mat); cyl.position.y = 1.0; group.add(cyl); group.position.set(x, 0.5, z); group.userData = { type: 'dump' }; group.userData.rotSpeed = 0.05; scene.add(group); objects.push(group); }

        function spawnEnvironment() {
            if (!gameState.running) return;
            if (Math.random() < 0.15) {
                const zPos = -100; const side = Math.random() < 0.5 ? -1 : 1; const xPos = side * (9 + Math.random() * 5);
                let mesh; const randType = Math.random();
                if (randType < 0.5) { 
                    const height = 15 + Math.random() * 25; const width = 6 + Math.random() * 4;
                    const geo = new THREE.BoxGeometry(width, height, 8); const tex = AssetManager.createBuildingTexture();
                    const mat = new THREE.MeshPhongMaterial({ map: tex }); mesh = new THREE.Mesh(geo, mat); mesh.position.set(xPos, height/2, zPos); mesh.castShadow = true;
                    if(Math.random() < 0.3) {
                        const symbols = ['BTC', 'ETH']; const sym = symbols[Math.floor(Math.random()*symbols.length)];
                        const logoGeo = new THREE.CylinderGeometry(2, 2, 0.5, 32); logoGeo.rotateX(Math.PI/2);
                        const logoMat = new THREE.MeshPhongMaterial({map: AssetManager.getCryptoLogo(sym), emissive: 0x333333});
                        const logo = new THREE.Mesh(logoGeo, logoMat); logo.position.set(0, height/2 + 2, 0); logo.rotation.y = side > 0 ? -Math.PI/4 : Math.PI/4;
                        mesh.add(logo); mesh.userData.rotates = true;
                    }
                } else if (randType < 0.8) { 
                    mesh = new THREE.Group(); 
                    const trunk = new THREE.Mesh(new THREE.CylinderGeometry(0.3, 0.5, 3), new THREE.MeshLambertMaterial({color: 0x4a3c31})); trunk.position.y = 1.5; mesh.add(trunk); 
                    const leaves = new THREE.Mesh(new THREE.IcosahedronGeometry(2, 1), new THREE.MeshLambertMaterial({color: 0x228b22})); leaves.position.y = 4; mesh.add(leaves); 
                    mesh.position.set(side * 8, 0, zPos);
                } else { 
                    mesh = new THREE.Group(); const pole = new THREE.Mesh(new THREE.CylinderGeometry(0.1, 0.1, 8), new THREE.MeshPhongMaterial({color:0x333})); pole.position.y = 4; mesh.add(pole); const arm = new THREE.Mesh(new THREE.BoxGeometry(2, 0.2, 0.2), new THREE.MeshPhongMaterial({color:0x333})); arm.position.set(side * -1, 7.5, 0); mesh.add(arm); const bulb = new THREE.PointLight(COLORS.LAMP, 1, 15); bulb.position.set(side * -2, 7.2, 0); mesh.add(bulb); const bulbMesh = new THREE.Mesh(new THREE.BoxGeometry(0.5,0.2,0.4), new THREE.MeshBasicMaterial({color:0xffaa00})); bulbMesh.position.set(side * -2, 7.4, 0); mesh.add(bulbMesh); mesh.position.set(side * 9, 0, zPos);
                }
                scene.add(mesh); envObjects.push(mesh);
            }
        }

        function spawnObject() {
            if (!gameState.running || gameState.crashed) return;
            const lanes = [-3, 0, 3]; const lane = lanes[Math.floor(Math.random() * lanes.length)]; const rand = Math.random();
            const difficulty = Math.min(1, Math.max(0, (gameState.baseSpeed - OYUN_AYARLARI.baslangicHizi) / 1.0));
            let trafficChance = (0.15 + (difficulty * 0.35)) * OYUN_AYARLARI.trafikYogunlugu;
            
            if (rand < trafficChance) { createCar(lane, -100); } 
            else if (rand < trafficChance + 0.05) { 
                const geo = new THREE.ConeGeometry(0.5, 1, 32); const mat = new THREE.MeshPhongMaterial({color: 0x00ffff, emissive:0x004444}); const mesh = new THREE.Mesh(geo, mat); mesh.rotation.x = Math.PI; mesh.position.set(lane, 1, -100); mesh.userData = { type: 'nitro' }; scene.add(mesh); objects.push(mesh);
            }
            else if (rand < trafficChance + 0.08) { 
                 const canvas = document.createElement('canvas'); canvas.width=64; canvas.height=64; const ctx=canvas.getContext('2d'); ctx.font='50px Arial'; ctx.fillText('üõ°Ô∏è', 5, 50);
                 const mesh = new THREE.Sprite(new THREE.SpriteMaterial({map:new THREE.CanvasTexture(canvas)}));
                 mesh.scale.set(1.5, 1.5, 1); mesh.position.set(lane, 1, -100); mesh.userData = { type: 'shield' }; scene.add(mesh); objects.push(mesh);
            }
            else if (rand < trafficChance + 0.15) { 
                if(Math.random() > difficulty * 0.5) createPump(lane, -100); else createDump(lane, -100);
            }
            else if (rand < trafficChance + 0.22) { createDump(lane, -100); }
            else if (rand < 0.7) { 
                const geo = new THREE.CylinderGeometry(0.5, 0.5, 0.1, 32); geo.rotateX(Math.PI/2);
                const mat = new THREE.MeshPhongMaterial({map: AssetManager.getCoinTexture(), shininess:150, color: 0xffffff});
                const mesh = new THREE.Mesh(geo, mat); mesh.rotation.y = Math.PI/2; mesh.position.set(lane, 0.7, -100); mesh.userData = { type: 'coin' }; scene.add(mesh); objects.push(mesh);
            }
        }

        function animate() {
            requestAnimationFrame(animate); if (!gameState.running) return;
            const delta = clock.getDelta();
            const speed = gameState.currentSpeed;
            gameState.distanceTraveled += speed * 0.1;

            if (gameState.baseSpeed < OYUN_AYARLARI.maksimumHiz) { 
                // Hƒ±zlanma oranƒ±: 0.001
                gameState.baseSpeed = OYUN_AYARLARI.baslangicHizi + Math.min(1.0, gameState.distanceTraveled * 0.001);
            }

            if(gameState.shieldTime > 0) {
                gameState.shieldTime -= delta;
                if(shieldMesh) { shieldMesh.visible = true; shieldMesh.rotation.y += delta*2; }
                document.getElementById('shield-status').style.display = 'block';
                if(gameState.shieldTime <= 0) { if(shieldMesh) shieldMesh.visible=false; document.getElementById('shield-status').style.display='none'; }
            }

            if (gameState.nitroTime > 0) {
                gameState.nitroTime -= delta; gameState.currentSpeed = gameState.baseSpeed + 0.4; 
                if(camera.fov < 85) { camera.fov += 0.5; camera.updateProjectionMatrix(); }
                document.getElementById('speed-lines').style.opacity = '0.7'; document.getElementById('nitro-status').style.display = 'block';
            } else {
                gameState.currentSpeed = gameState.baseSpeed;
                if(camera.fov > 60) { camera.fov -= 0.5; camera.updateProjectionMatrix(); }
                document.getElementById('speed-lines').style.opacity = Math.min(0.3, (gameState.baseSpeed - 0.5));
                document.getElementById('nitro-status').style.display = 'none';
            }

            if(roadMesh) roadMesh.material.map.offset.y -= speed * 0.05;

            if(bike) {
                bike.position.x += (input.targetX - bike.position.x) * 0.1;
                bike.rotation.z = (bike.position.x - input.targetX) * 0.25; 
                bike.rotation.y = (input.targetX - bike.position.x) * 0.15; 
            }
            
            spawnEnvironment();
            for (let i = envObjects.length - 1; i >= 0; i--) { let obj = envObjects[i]; obj.position.z += speed; if(obj.userData.rotates) obj.children[0].rotation.y += 0.02; if(obj.position.z > 20) { scene.remove(obj); envObjects.splice(i, 1); } }
            if (Math.random() < 0.02 + (gameState.currentSpeed * 0.04)) spawnObject(); 

            for (let i = objects.length - 1; i >= 0; i--) {
                let obj = objects[i]; let relativeSpeed = speed; 
                if (obj.userData.type === 'car') relativeSpeed = speed - 0.25;
                obj.position.z += relativeSpeed;
                if (['coin', 'nitro', 'pump', 'dump'].includes(obj.userData.type)) { obj.rotation.y += 0.05; }
                if (bike && obj.position.distanceTo(bike.position) < 1.5) handleCollision(obj, i);
                else if (obj.position.z > 10) { scene.remove(obj); objects.splice(i, 1); }
            }
            renderer.render(scene, camera);
        }
        
        // --- YARDIMCI FONKSƒ∞YONLAR ---
        function showFloatingText(text, color) {
            const el = document.createElement('div'); el.className = 'float-text'; el.innerText = text;
            el.style.color = color === COLORS.GREEN ? '#00ff88' : '#ff4455';
            if(color === COLORS.BITGET_BLUE) el.style.color = '#0088ff';
            el.style.left = '50%'; el.style.top = '40%'; el.style.transform = 'translate(-50%, -50%)';
            document.getElementById('floating-text-container').appendChild(el);
            setTimeout(() => el.remove(), 1000);
        }

        function handleCollision(obj, index) {
            const type = obj.userData.type;
            if (type === 'coin') { gameState.score += 100; updateScoreText(); scene.remove(obj); objects.splice(index, 1); } 
            else if (type === 'nitro') { gameState.nitroTime = 3.0; scene.remove(obj); objects.splice(index, 1); } 
            else if (type === 'shield') { gameState.shieldTime = OYUN_AYARLARI.kalkanSuresi; scene.remove(obj); objects.splice(index, 1); } 
            else if (type === 'pump') { const gain = Math.floor(gameState.score * 0.10); const add = Math.max(50, gain); gameState.score += add; showFloatingText(`PUMP! +${add}`, COLORS.GREEN); updateScoreText(); scene.remove(obj); objects.splice(index, 1); } 
            else if (type === 'dump') { if (gameState.shieldTime > 0) { showFloatingText("KALKAN KORUDU!", COLORS.BITGET_BLUE); } else { const loss = Math.floor(gameState.score * 0.10); gameState.score -= loss; if(gameState.score < 0) gameState.score = 0; showFloatingText(`DUMP! -${loss}`, COLORS.RED); updateScoreText(); } scene.remove(obj); objects.splice(index, 1); } 
            else if (type === 'car') { if(gameState.shieldTime > 0) { scene.remove(obj); objects.splice(index, 1); showFloatingText("BOM!", COLORS.BITGET_BLUE); } else { gameOver(); } }
        }

        function updateScoreText() { document.getElementById('score-text').innerText = gameState.score + " BGB"; }
        function handleInput(e) { if (!gameState.running || input.isActive || gameState.crashed) return; e.preventDefault(); let cx = e.touches ? e.touches[0].clientX : e.clientX; input.targetX = Math.max(-4, Math.min(4, ((cx / window.innerWidth) * 2 - 1) * 5)); }
        function startGame() { document.getElementById('start-screen').style.display = 'none'; gameState.running = true; gameState.crashed = false; gameState.score = 0; gameState.baseSpeed = OYUN_AYARLARI.baslangicHizi; gameState.nitroTime=0; gameState.shieldTime=0; gameState.distanceTraveled=0; updateScoreText(); clock.start(); }
        function gameOver() { gameState.running = false; document.getElementById('final-score').innerText = gameState.score; document.getElementById('game-over-modal').style.display = 'block'; }
        function resetGame() { objects.forEach(o => scene.remove(o)); envObjects.forEach(e => scene.remove(e)); objects = []; envObjects = []; bike.position.x = 0; bike.rotation.set(0,0,0); gameState.running = true; gameState.score = 0; gameState.baseSpeed = OYUN_AYARLARI.baslangicHizi; gameState.nitroTime=0; gameState.shieldTime=0; gameState.distanceTraveled=0; updateScoreText(); document.getElementById('game-over-modal').style.display = 'none'; if(shieldMesh) shieldMesh.visible=false; document.getElementById('shield-status').style.display='none'; }
        function onWindowResize() { camera.aspect = window.innerWidth/window.innerHeight; camera.updateProjectionMatrix(); renderer.setSize(window.innerWidth, window.innerHeight); }
        function initTelegram() { if (window.Telegram?.WebApp) { const tg = window.Telegram.WebApp; tg.ready(); tg.expand(); if(tg.initDataUnsafe?.user?.first_name) { const inp = document.getElementById('player-name'); if(inp) inp.value = tg.initDataUnsafe.user.first_name; } } }

        // D√úZELTME 2: Firebase Auth ba≈üarƒ±lƒ± olunca gameState'i g√ºncelliyoruz.
        async function initFirebase() { 
            if (firebaseConfig.apiKey === "AIzaSyBsyA9O5a6T07619VVr12ET4EAcRqAut7w") return; 
            try { 
                const app = firebase.initializeApp(firebaseConfig);
                db = firebase.firestore(); 
                auth = firebase.auth(); 

                // Canvas ortamƒ±nda token varsa kullan, yoksa anonim giri≈ü yap.
                const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
                if (initialAuthToken) {
                    await auth.signInWithCustomToken(initialAuthToken);
                } else {
                    await auth.signInAnonymously();
                }
                
                gameState.isAuthReady = true; // Yetkilendirme tamamlandƒ±.
                console.log("Firebase Yetkilendirmesi Ba≈üarƒ±lƒ±. Skor Kaydƒ± Aktif.");
            } catch(e) { 
                console.error("Firebase ba≈ülatma veya kimlik doƒürulama hatasƒ±:", e); 
            } 
        }

        // Skor kaydetme ve skor tablosunu g√∂sterme fonksiyonlarƒ±nda yetkilendirme kontrol√º korunuyor.
        async function saveScoreAndShowLeaderboard() { 
            if(!db || !gameState.isAuthReady) { 
                console.error("Veritabanƒ± hazƒ±r deƒüil veya yetkilendirme bekleniyor. L√ºtfen birka√ß saniye bekleyip tekrar deneyin.");
                alert("Veritabanƒ± baƒülantƒ±sƒ± hen√ºz kurulmadƒ±. L√ºtfen bekleyip tekrar deneyin.");
                return; 
            } 
            const n=document.getElementById('player-name').value||"Trader"; 
            
            // Kullanƒ±cƒ± kimliƒüini al
            const userId = auth.currentUser ? auth.currentUser.uid : 'anon_user';

            try{ 
                // Public veri yolu: /artifacts/{appId}/public/data/leaderboard
                const collectionPath = `artifacts/${appId}/public/data/leaderboard`;

                await db.collection(collectionPath).add({
                    name: n, 
                    score: gameState.score, 
                    userId: userId, // Kaydƒ± kimin yaptƒ±ƒüƒ±nƒ± bilmek i√ßin
                    timestamp: firebase.firestore.FieldValue.serverTimestamp()
                }); 
                document.getElementById('game-over-modal').style.display='none'; 
                showLeaderboardOnly(); 
            } catch(e){
                 console.error("Skor kaydetme hatasƒ±:", e);
                 alert("Skor kaydedilemedi. Firebase ayarlarƒ±nƒ±zƒ± kontrol edin.");
            } 
        }

        async function showLeaderboardOnly() { 
            document.getElementById('leaderboard-modal').style.display='block'; 
            const l=document.getElementById('leaderboard-list'); 
            l.innerHTML='<li>Y√ºkleniyor...</li>'; 
            
            if(!db || !gameState.isAuthReady) { 
                l.innerHTML = '<li>Veritabanƒ± baƒülantƒ±sƒ± veya yetkilendirme bekleniyor. L√ºtfen bekleyip tekrar deneyin.</li>';
                return; 
            } 
            
            try {
                // Public veri yolu: /artifacts/{appId}/public/data/leaderboard
                const collectionPath = `artifacts/${appId}/public/data/leaderboard`;
                
                // Firestore'dan en iyi 10 skoru al
                const s = await db.collection(collectionPath)
                                  .orderBy('score', 'desc')
                                  .limit(10)
                                  .get(); 
                                  
                l.innerHTML=''; 
                s.forEach((d,i)=>{
                    const dt=d.data();
                    const li=document.createElement('li');
                    li.innerHTML=`<span>${i+1}. ${dt.name}</span> <span>${dt.score} BGB</span>`;
                    l.appendChild(li);
                }); 
            } catch (e) {
                console.error("Lider tablosu y√ºklenemedi:", e);
                l.innerHTML = '<li>Skorlar y√ºklenirken bir hata olu≈ütu.</li>';
            }
        }

        function closeLeaderboard() { document.getElementById('leaderboard-modal').style.display='none'; }
        function shareToTelegram() { const t=`Bitget Moto'da ${gameState.score} BGB topladƒ±m!`; window.open(`https://t.me/share/url?url=${encodeURIComponent(window.location.href)}&text=${encodeURIComponent(t)}`,'_blank'); }
    </script>
</body>
</html>
